#!/bin/bash

if [ -z "$1" ]; then
    echo "Enter a command, Use 'frostproxy help' for more info"
fi

if [ "$1" == "help" ]; then
    echo "Usage: frostproxy [command]"
    echo ""
    echo "Commands:"
    echo "  config token [token]"
    echo "  tunnel target 3000 example.com --ssl (OR for no ssl) tunnel target 3000 example.com"
    echo "  list [tunnels]"
fi

if [ "$1" == "config" ]; then
    if [ -z "$2" ]; then
        echo "specify a config: token"
    fi
    
    configfile='/var/frostproxy/config.cfg'
    
    if [ ! -f "${configfile}" ] ; then
        mkdir -p /var/frostproxy/
        touch $configfile
        echo "token=\"$2\"" | sudo tee --append $configfile
    fi
fi

if [ "$1" == "tunnel" ]; then
    target="$2"
    domain_found=false
    ssl_found=false
    configfile='/var/frostproxy/config.cfg'
    
    if [ ! -f "${configfile}" ] ; then
        echo "config file not found, run 'frostproxy config [token]'"
        exit 1
    else
        
        source $configfile
        if [ -f "$token" ]; then
            echo "token not found, run 'frostproxy config [token]'"
            exit 1
        else
            if [ -z "$2" ]; then
                echo "specify a target: 8000"
                exit 1
            fi
            

for arg in "$@"; do
  if [[ "$arg" == *"--domain="* ]]; then
    domain=$(echo "$arg" | awk -F '=' '{print $2}')
    domain_found=true
  fi
done

for arg in "$@"; do
  if [[ "$arg" == *"--ssl="* ]]; then
    ssl_found=true
  fi
done


            

            echo "Creating tunnel..."

            set IP=%hostname -I | awk '{print $1}'

            if [ "$domain_found" == true ]; then
                 echo "Domain: $domain"


                 if [ "$ssl_found" == true ]; then
                     echo "domain = $domain | ssl = true"
                 else
                     echo "domain = $domain | ssl = false"
                 fi


            else
              echo "Domain not found, generating a domain"
              ssl_found=true
            fi


            #set /a sum=%IP% + %2
            #responsetunnel=curl -X POST https://frostproxy.com/api/tunnel/add/"$domain" -d "{ ID: '$token', target: '%sum%', ssl: '$ssl' }"



            #if [ "$responsetunnel.statusCode" == "200" ]; then
            #    echo "Tunnel created successfully"
            #    exit 1
           # fi

            #if [ "$responsetunnel.statusCode" == "400" ]; then
            #    echo "Tunnel already exists"
            #    exit 1
           # fi

           # if [ "$responsetunnel.statusCode" == "500" ]; then
           #     echo "Invalid token"
           #     exit 1
           # fi

            echo "Tunnel Running! Press CTRL+C to exit."
            

               echo "Session Status:          Online"
               echo "Tunnels:                 1"
               echo "Website Interface:       $domain"
               if [ "$ssl_found" == "true" ]; then
                   echo "Forwarding:              https://$domain -> $target"
               fi
               if [ "$ssl_found" == "false" ]; then
                   echo "Forwarding:              http://$domain -> $target"
               fi

               trap "echo 'User has exited the session & tunnel has been deleted!'; exit" SIGINT

           while true; do
           sleep 1
           done
            
        fi
    fi
fi

if [ "$1" == "list" ]; then
    echo "Listing tunnels..."

    configfile='/var/frostproxy/config.cfg'
    
    if [ ! -f "${configfile}" ] ; then
        echo "config file not found, run 'frostproxy config [token]'"
        exit 1
    fi
        
        source $configfile
        if [ -f "$token" ]; then
            echo "token not found, run 'frostproxy config [token]'"
            exit 1
        fi


response=$(curl -s -i -X POST https://frostproxy.com/api/tunnel/list -d '{ 
 "ID": "$token"
}')

echo "$response" | grep -o "HTTP/[0-9.]* [0-9]*"

    


fi